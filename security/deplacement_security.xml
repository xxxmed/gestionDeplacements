<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data noupdate="0">
        
        <!-- Groupe 1: Employé (Demandeur) -->
        <record id="group_deplacement_employee" model="res.groups">
            <field name="name">Gestion Déplacement / Employé</field>
            <field name="implied_ids" eval="[(4, ref('base.group_user'))]"/>
            <field name="comment">L'employé peut créer et soumettre ses propres demandes de déplacement. Il ne voit que ses propres demandes.</field>
        </record>

        <!-- Groupe 2: Manager (Validateur Unique) -->
        <record id="group_deplacement_manager" model="res.groups">
            <field name="name">Gestion Déplacement / Manager</field>
            <field name="implied_ids" eval="[(4, ref('group_deplacement_employee'))]"/>
            <field name="comment">Le manager valide les demandes de son équipe. Il peut approuver ou refuser les demandes.</field>
        </record>

        <!-- Groupe 3: DAF (Gestionnaire/Processeur) -->
        <record id="group_deplacement_daf" model="res.groups">
            <field name="name">Gestion Déplacement / DAF</field>
            <field name="implied_ids" eval="[(4, ref('group_deplacement_manager'))]"/>
            <field name="comment">Le DAF gère l'aspect logistique et financier des demandes validées. Il voit toutes les demandes pour supervision budgétaire.</field>
        </record>

        <!-- Règles de sécurité Record Rules -->
        
        <!-- Règle 1: L'employé ne voit que ses propres demandes -->
        <record id="deplacement_demande_employee_rule" model="ir.rule">
            <field name="name">Employé: Ses propres demandes</field>
            <field name="model_id" ref="model_gestion_deplacement_demande"/>
            <field name="domain_force">[('employee_id.user_id', '=', user.id)]</field>
            <field name="groups" eval="[(4, ref('group_deplacement_employee'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="True"/>
            <field name="perm_create" eval="True"/>
            <field name="perm_unlink" eval="True"/>
        </record>

        <!-- Règle 2: Le manager voit les demandes de son équipe -->
        <record id="deplacement_demande_manager_rule" model="ir.rule">
            <field name="name">Manager: Demandes de son équipe</field>
            <field name="model_id" ref="model_gestion_deplacement_demande"/>
            <field name="domain_force">[('manager_id.user_id', '=', user.id)]</field>
            <field name="groups" eval="[(4, ref('group_deplacement_manager'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="True"/>
            <field name="perm_create" eval="False"/>
            <field name="perm_unlink" eval="False"/>
        </record>

        <!-- Règle 3: Le DAF voit toutes les demandes -->
        <record id="deplacement_demande_daf_rule" model="ir.rule">
            <field name="name">DAF: Toutes les demandes</field>
            <field name="model_id" ref="model_gestion_deplacement_demande"/>
            <field name="domain_force">[(1, '=', 1)]</field>
            <field name="groups" eval="[(4, ref('group_deplacement_daf'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="True"/>
            <field name="perm_create" eval="True"/>
            <field name="perm_unlink" eval="True"/>
        </record>

        <!-- Règle pour les villes: Tout le monde peut les voir -->
        <record id="deplacement_ville_all_rule" model="ir.rule">
            <field name="name">Ville: Lecture pour tous</field>
            <field name="model_id" ref="model_gestion_deplacement_ville"/>
            <field name="domain_force">[(1, '=', 1)]</field>
            <field name="groups" eval="[(4, ref('group_deplacement_employee'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="False"/>
            <field name="perm_create" eval="False"/>
            <field name="perm_unlink" eval="False"/>
        </record>

        <!-- Règle pour les villes: DAF peut tout gérer -->
        <record id="deplacement_ville_daf_rule" model="ir.rule">
            <field name="name">Ville: Gestion DAF</field>
            <field name="model_id" ref="model_gestion_deplacement_ville"/>
            <field name="domain_force">[(1, '=', 1)]</field>
            <field name="groups" eval="[(4, ref('group_deplacement_daf'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="True"/>
            <field name="perm_create" eval="True"/>
            <field name="perm_unlink" eval="True"/>
        </record>

    </data>
</odoo>
