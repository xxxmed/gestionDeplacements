<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- ============================================ -->
        <!-- ACTIONS DE MENU -->
        <!-- ============================================ -->

        <!-- Action pour les demandes de déplacement -->
        <record id="action_demande_deplacement" model="ir.actions.act_window">
            <field name="name">Demandes de Déplacement</field>
            <field name="res_model">gestion.deplacement.demande</field>
            <field name="view_mode">list,form,kanban,calendar,pivot,graph</field>
            <field name="context">{}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Créer une nouvelle demande de déplacement
                </p>
                <p>
                    Cliquez sur "Nouveau" pour créer votre première demande de déplacement.
                </p>
            </field>
        </record>

        <!-- Action pour mes demandes (Employé) -->
        <record id="action_mes_demandes" model="ir.actions.act_window">
            <field name="name">Mes Demandes</field>
            <field name="res_model">gestion.deplacement.demande</field>
            <field name="view_mode">list,form,kanban</field>
            <field name="domain">[('employee_id.user_id', '=', uid)]</field>
            <field name="context">{}</field>
        </record>

        <!-- Action pour demandes à valider (Manager) -->
        <record id="action_demandes_a_valider" model="ir.actions.act_window">
            <field name="name">À Valider</field>
            <field name="res_model">gestion.deplacement.demande</field>
            <field name="view_mode">list,form,kanban</field>
            <field name="domain">[('state', '=', 'soumis'), ('manager_id.user_id', '=', uid)]</field>
            <field name="context">{}</field>
        </record>

        <!-- Action pour demandes à traiter (DAF) -->
        <record id="action_demandes_a_traiter" model="ir.actions.act_window">
            <field name="name">À Traiter</field>
            <field name="res_model">gestion.deplacement.demande</field>
            <field name="view_mode">list,form,kanban</field>
            <field name="domain">[('state', 'in', ['approuve', 'en_cours'])]</field>
            <field name="context">{}</field>
        </record>

        <!-- ============================================ -->
        <!-- VUE TREE (Liste) -->
        <!-- ============================================ -->

        <record id="view_demande_deplacement_tree" model="ir.ui.view">
            <field name="name">gestion.deplacement.demande.tree</field>
            <field name="model">gestion.deplacement.demande</field>
            <field name="arch" type="xml">
                <list string="Demandes de Déplacement" 
                      decoration-info="state == 'brouillon'"
                      decoration-warning="state in ('soumis', 'en_cours')"
                      decoration-success="state in ('approuve', 'termine')"
                      decoration-danger="state == 'refuse'"
                      decoration-muted="state == 'annule'">
                    <field name="name" string="Référence"/>
                    <field name="employee_id" string="Employé" optional="hide"/>
                    <field name="manager_id" string="Manager" optional="hide"/>
                    <field name="date_debut" string="Du"/>
                    <field name="date_fin" string="Au"/>
                    <field name="nb_jours" string="Jours" optional="show"/>
                    <field name="destination_city_id" string="Destination"/>
                    <field name="is_international" string="International" optional="hide"/>
                    <field name="mode_transport" string="Transport"/>
                    <field name="classe_voyage" string="Classe" optional="hide"/>
                    <field name="distance_estimee" string="Distance (Km)" optional="hide"/>
                    <field name="currency_id" invisible="1"/>
                    <field name="montant_frais" string="Montant" sum="Total" widget="monetary"/>
                    <field name="state" string="État" widget="badge" 
                           decoration-info="state == 'brouillon'"
                           decoration-warning="state in ('soumis', 'en_cours')"
                           decoration-success="state in ('approuve', 'termine')"
                           decoration-danger="state == 'refuse'"/>
                    <field name="company_id" invisible="1"/>
                    <field name="active" invisible="1"/>
                </list>
            </field>
        </record>

        <!-- ============================================ -->
        <!-- VUE FORM (Formulaire) -->
        <!-- ============================================ -->

        <record id="view_demande_deplacement_form" model="ir.ui.view">
            <field name="name">gestion.deplacement.demande.form</field>
            <field name="model">gestion.deplacement.demande</field>
            <field name="arch" type="xml">
                <form string="Demande de Déplacement">
                    <header>
                        <!-- EMPLOYÉ: Soumettre -->
                        <button name="action_submit" 
                                string="Soumettre" 
                                type="object" 
                                class="btn-primary"
                                invisible="state != 'brouillon'"
                                groups="gestionDeplacements.group_deplacement_employee"/>
                        
                        <!-- MANAGER: Approuver/Refuser -->
                        <button name="action_approve" 
                                string="Valider" 
                                type="object" 
                                class="btn-success"
                                invisible="state != 'soumis'"
                                groups="gestionDeplacements.group_deplacement_manager"/>
                        
                        <button name="action_refuse" 
                                string="Refuser" 
                                type="object" 
                                class="btn-danger"
                                invisible="state not in ['soumis','approuve']"
                                groups="gestionDeplacements.group_deplacement_manager"/>
                        
                        <!-- DAF: Prendre en charge/Terminer -->
                        <button name="action_process" 
                                string="Prendre en charge" 
                                type="object" 
                                class="btn-primary"
                                invisible="state != 'approuve'"
                                groups="gestionDeplacements.group_deplacement_daf"/>
                        
                        <button name="action_complete" 
                                string="Terminer" 
                                type="object" 
                                class="btn-success"
                                invisible="state != 'en_cours'"
                                groups="gestionDeplacements.group_deplacement_daf"/>
                        
                        <!-- Remettre en brouillon -->
                        <button name="action_reset_draft" 
                                string="Remettre en brouillon" 
                                type="object"
                                class="btn-secondary"
                                invisible="state != 'refuse'"
                                groups="gestionDeplacements.group_deplacement_manager"/>
                        
                        <field name="state" widget="statusbar" 
                               statusbar_visible="brouillon,soumis,approuve,en_cours,termine"/>
                    </header>
                    
                    <sheet>
                        <div class="oe_button_box" name="button_box">
                            <button name="toggle_active" type="object" class="oe_stat_button" icon="fa-archive">
                                <field name="active" widget="boolean_button" options='{"terminology": "archive"}'/>
                            </button>
                        </div>
                        
                        <div class="oe_title">
                            <h1>
                                <field name="name" readonly="1"/>
                            </h1>
                        </div>
                        
                        <group>
                            <group string="Informations générales">
                                <field name="employee_id" 
                                       options="{'no_create': True, 'no_open': True}" 
                                       readonly="1"/>
                                <field name="manager_id" readonly="1"/>
                                <field name="date_debut" readonly="state != 'brouillon'"/>
                                <field name="date_fin" readonly="state != 'brouillon'"/>
                                <field name="nb_jours" readonly="1"/>
                            </group>
                            
                            <group string="Destination">
                                <field name="destination_city_id" 
                                       options="{'no_create': True}" 
                                       readonly="state != 'brouillon'"/>
                                <field name="is_international" invisible="1"/>
                                <field name="distance_estimee" readonly="state != 'brouillon'"/>
                            </group>
                        </group>
                        
                        <group>
                            <group string="Transport">
                                <field name="mode_transport" readonly="state != 'brouillon'"/>
                                <field name="vehicule_id" 
                                       options="{'no_create': True}" 
                                       invisible="mode_transport != 'vehicule_service'" 
                                       required="mode_transport == 'vehicule_service'" 
                                       readonly="state != 'brouillon'"/>
                                <field name="classe_voyage" 
                                       invisible="mode_transport != 'avion'" 
                                       readonly="1"/>
                            </group>
                            
                            <group string="Coûts">
                                <field name="currency_id" invisible="1"/>
                                <field name="montant_frais" widget="monetary" readonly="1"/>
                            </group>
                        </group>
                        
                        <group string="Ordre de mission">
                            <field name="ordre_mission_file" 
                                   filename="ordre_mission_filename" 
                                   readonly="state != 'brouillon'"/>
                            <field name="ordre_mission_filename" invisible="1"/>
                        </group>
                        
                        <notebook>
                            <page string="Mission" name="mission">
                                <group>
                                    <field name="mission_objet" 
                                           placeholder="Décrivez l'objet de la mission..." 
                                           readonly="state not in ['brouillon','soumis']"/>
                                </group>
                            </page>
                            
                            <page string="Motif de refus" 
                                  name="motif_refus" 
                                  invisible="state != 'refuse'">
                                <field name="motif_refus" readonly="1"/>
                            </page>
                        </notebook>
                    </sheet>
                    
                    <!-- Chatter (Messages et Activités) -->
                    <div class="oe_chatter">
                        <field name="message_ids"/>
                    </div>
                </form>
            </field>
        </record>

        <!-- ============================================ -->
        <!-- VUE KANBAN -->
        <!-- ============================================ -->

        <record id="view_demande_deplacement_kanban" model="ir.ui.view">
            <field name="name">gestion.deplacement.demande.kanban</field>
            <field name="model">gestion.deplacement.demande</field>
            <field name="arch" type="xml">
                <kanban class="o_kanban_mobile" default_group_by="state">
                    <field name="name"/>
                    <field name="employee_id"/>
                    <field name="destination_city_id"/>
                    <field name="date_debut"/>
                    <field name="date_fin"/>
                    <field name="montant_frais"/>
                    <field name="state"/>
                    <templates>
                        <t t-name="kanban-box">
                            <div class="oe_kanban_global_click">
                                <div class="o_kanban_record_top">
                                    <div class="o_kanban_record_headings">
                                        <strong class="o_kanban_record_title">
                                            <field name="name"/>
                                        </strong>
                                    </div>
                                    <span class="float-end badge badge-pill">
                                        <field name="state" widget="label_selection"
                                               options="{'classes': {
                                                   'brouillon': 'secondary',
                                                   'soumis': 'info',
                                                   'approuve': 'primary',
                                                   'en_cours': 'warning',
                                                   'termine': 'success',
                                                   'refuse': 'danger',
                                                   'annule': 'dark'
                                               }}"/>
                                    </span>
                                </div>
                                <div class="o_kanban_record_body">
                                    <div>
                                        <i class="fa fa-user"/> <field name="employee_id"/>
                                    </div>
                                    <div>
                                        <i class="fa fa-map-marker"/> <field name="destination_city_id"/>
                                    </div>
                                    <div>
                                        <i class="fa fa-calendar"/> 
                                        <field name="date_debut"/> - <field name="date_fin"/>
                                    </div>
                                </div>
                                <div class="o_kanban_record_bottom">
                                    <div class="oe_kanban_bottom_left">
                                        <strong><field name="montant_frais" widget="monetary"/> MAD</strong>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </templates>
                </kanban>
            </field>
        </record>

        <!-- ============================================ -->
        <!-- VUE CALENDAR -->
        <!-- ============================================ -->

        <record id="view_demande_deplacement_calendar" model="ir.ui.view">
            <field name="name">gestion.deplacement.demande.calendar</field>
            <field name="model">gestion.deplacement.demande</field>
            <field name="arch" type="xml">
                <calendar string="Calendrier des Déplacements" 
                          date_start="date_debut" 
                          date_stop="date_fin"
                          color="employee_id"
                          mode="month">
                    <field name="name"/>
                    <field name="employee_id"/>
                    <field name="destination_city_id"/>
                    <field name="state" filters="1" invisible="1"/>
                </calendar>
            </field>
        </record>

        <!-- ============================================ -->
        <!-- VUE SEARCH (Filtres et Groupements) -->
        <!-- ============================================ -->

    <!-- Search view removed temporarily -->

        <!-- ============================================ -->
        <!-- VUE PIVOT (Tableau croisé) -->
        <!-- ============================================ -->

        <record id="view_demande_deplacement_pivot" model="ir.ui.view">
            <field name="name">gestion.deplacement.demande.pivot</field>
            <field name="model">gestion.deplacement.demande</field>
            <field name="arch" type="xml">
                <pivot string="Analyse des Déplacements">
                    <field name="employee_id" type="row"/>
                    <field name="state" type="col"/>
                    <field name="montant_frais" type="measure"/>
                </pivot>
            </field>
        </record>

        <!-- ============================================ -->
        <!-- VUE GRAPH (Graphique) -->
        <!-- ============================================ -->

        <record id="view_demande_deplacement_graph" model="ir.ui.view">
            <field name="name">gestion.deplacement.demande.graph</field>
            <field name="model">gestion.deplacement.demande</field>
            <field name="arch" type="xml">
                <graph string="Statistiques des Déplacements" type="bar">
                    <field name="state"/>
                    <field name="montant_frais" type="measure"/>
                </graph>
            </field>
        </record>

    </data>
</odoo>

